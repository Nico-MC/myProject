<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
    <title>myproject</title>
    <!-- CSS -->
    <!-- <link href="https://fonts.googleapis.com/css?family=Skranji:700" rel="stylesheet"-->
    <link rel="stylesheet" type="text/css" href="assets/css/page.css">
    <link rel="stylesheet" type="text/css" href="assets/css/game.css">
    <link rel="stylesheet" type="text/css" href="assets/css/auctionhouse.css">
    <link rel="stylesheet" type="text/css" href="assets/css/jquery-ui.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- DATABASE -->
    <!-- <script src="https://www.baqend.com/js-sdk/latest/baqend.min.js"></script> -->
    <!-- <script type="text/javascript" src="//unpkg.com/@reactivex/rxjs@5.2.0/dist/global/Rx.js"></script> -->
    <!-- include the SDK after rxjs -->
    <script type="text/javascript" src="//www.baqend.com/js-sdk/latest/baqend-realtime.js"></script>
    <!-- MODULES -->
    <!-- <script type="text/javascript" src="modules/phaser.min.js"></script> -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.21.0/moment.min.js"></script>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
  </head>
  <body>
    <section></section>

    <script type="text/javascript" src="js/db_baqend.js"></script>
    <script type="text/javascript">

      // Load mit Vorsicht genießen, da asynchron.
      // Für synchrones Laden: Ajax
      function transferToLogin(sk) {
        if(DB.User.me.securitykey == sk) {
          $.ajax({
            url: "assets/content/content.html",
            success: function(data) {
              var data = $(data).filter('.login_content');
              $('section').html(data);
              init(function() {
                loadLogin(); //race conditions? https://stackoverflow.com/questions/8611145/race-conditions-with-javascript-event-handling
              });
            }
          });

          function loadLogin() {
            DB.Items.load(itemsID, {depth: true}).then(function(loadedItems) {
              loadItems(loadedItems.itemlist);
            });
            DB.Auctions.load(auctionsID, {depth: true}).then(function(auctionItems) {
              loadAuctionItems(auctionItems.auctionlist);
            });

            // load user profile_option_div
            $('.profile_option_div .username').text(DB.User.me.username);
            $('.profile_option_div .bankbalance').text(DB.User.me.bankbalance);

            // query-ui slider
            var slider_hours = $("#auction_duration_slider_hours").slider();
            var slider_minutes = $("#auction_duration_slider_minutes").slider();
            var initSlider = function() {
              var options_hours = {
                min: 0,
                max: 48,
                value: 0,
                slide: function(e, ui) {
                  if(ui.value == 0) {
                    slider_minutes.slider("option", "min", 1);
                  }
                  else {
                    slider_minutes.slider("option", "min", 0);
                  }
                  if(ui.value == 48) {
                    slider_minutes.slider("disable");
                    slider_minutes.slider("option", "max", 0);
                  } else {
                    slider_minutes.slider("enable");
                    slider_minutes.slider("option", "max", 59);
                  }

                  var hours = ui.value;
                  var minutes = slider_minutes.slider("value");
                  $('#auctionDuration').val(hours + ":" + minutes);
                }
              }
              slider_hours.slider('option', options_hours);
              var options_minutes = {
                min: 0,
                max: 59,
                value: 0,
                slide: function(e, ui) {
                  var hours = slider_hours.slider("value");
                  var minutes = ui.value;
                  $('#auctionDuration').val(hours + ":" + minutes);
                }
              }
              slider_minutes.slider('option', options_minutes);

              $('#auctionDuration').val("0:1");
            }
            initSlider();

            $('.inventar_item').click(function(e) {
              var target = e.target;
              console.log(target);
            });

            $('#search').submit(function(e) {
              e.preventDefault();
              search_result = $('#search_field').val();
              search(search_result);
            });
            // Clear text search_field
            $("#search_field").val("");

            var streamlist;
            $('#check_realtime').change(function() {
              if(checkRealtime() && (streamlist == null)) {
                subscribeRealtime(sk, function(streams) {
                  streamlist = streams;
                  console.log("Realtime is on.");
                });
              } else {
                streamlist.forEach(function(stream) {
                  stream.unsubscribe();
                });
                streamlist = null;
                console.log("All streams unsubscribed.");
                console.log("Realtime is off.");
              }
            });

            // startGame();
          }
        }
      }

      function transferToRegister() {
        $.ajax({
          url: "assets/content/content.html",
          success: function(data) {
            var data = $(data).filter('.register_container');
            $('section').html(data);
            loadRegister();
          }
        });
        function loadRegister() {
          $('.register_div').fadeIn(2000);
          // Click on register-button
          $("#register").submit(function(event) {
            event.preventDefault();
            register($(this).serializeArray(), function(sk) {
              transferToLogin(sk);
            });
          });
          // Click on login-button
          $("#login").submit(function(event) {
            event.preventDefault();
            login($(this).serializeArray(), function(sk) {
              $.when( $('section .register_container').fadeOut("slow") ).done(function() {
                 transferToLogin(sk);
              });
            });
          });
        }
      }

      function loadItems(itemlist) {
        // if itemlist is not empty:
        function render(callback) {
          itemlist.forEach(function(value, key) {
            if(value.length != 0) {
              $('.inventar_div .no_items').fadeOut('fast').promise().done(function() {
                $(this).remove();
                if($('.inventar_div').find('.inventar_item.' + key).length === 0) {
                  $('<div class="inventar_item '+key+'" draggable="true" ondragstart="drag(event)"><span class="item_number strokeme">'+value.length+'</span></div>').appendTo('.inventar_div').show('slow');
                } else {
                  $('.inventar_item.'+key+' .item_number').html(value.length);
                }
              });
            } else {
              $('.inventar_item.'+key).hide('slow', function() { $(this).remove(); });
            }
          });

          return callback();
        }

        render(function() {
          setTimeout(function() {
            if($('.inventar_div > .inventar_item').length === 0 && $('.inventar_div > .no_items').length === 0) {
              $('.inventar_div').html('<span class="no_items">Keine Items vorhanden.</span>');
              $('.inventar_div .no_items').fadeIn("fast");
            }
          }, 1000);
          resize();
        });

      }

      function loadAuctionItems(auctionItems) {
        // if auctionlist is not empty:
        function render(callback) {
          auctionItems.forEach(function(auctionItem) {
            var itemKey = Object.keys(auctionItem)[0];
            var itemVal = Object.values(auctionItem)[0];
            var timeKey = Object.keys(auctionItem)[1];
            var timeVal = Object.values(auctionItem)[1];
            if(itemVal.length != 0) {
              $('.auction_div .no_items').fadeOut('fast').promise().done(function() {
                $(this).remove();
                if($('.auction_div').find('.auction_item#' + timeVal.end).length === 0) {
                  $('<div id="'+ timeVal.end +'" class="auction_item '+itemKey+'" draggable="false" ondragstart="drag(event)"><span class="item_number strokeme">'+itemVal.length+'</span></div>').appendTo('.auction_div').show('slow');
                } else {
                  $('.auction_item.'+itemKey+' .auction_number').html(itemVal.length);
                }
              });
            } else {
              $('.auction_item.'+ItemKey).hide('slow', function() { $(this).remove(); });
            }
          });

          return callback();
        }

        render(function() {
          setTimeout(function() {
            if($('.auction_div > .auction_item').length === 0 && $('.auction_div > .no_items').length === 0) {
              $('.auction_div').html('<span class="no_items">Keine Items vorhanden.</span>');
              $('.auction_div .no_items').fadeIn("fast");
            }
          }, 1000);
          resize();
        });
      }

      function updateItems(items) {
        loadItems(items.data.itemlist);
      }

      function updateAuctionItems(auctions) {
        loadItems(auctions.data.auctionlist);
      }

      function errormessage(message) {
        $('.alert').css('color', '#721c24');
        $('.alert').css('background-color', '#f8d7da');
        $('.alert').css('border-color', '#f5c6cb');
        $('.alert').html(message);
        $('.alert').toggle("slow").delay(2000).toggle("slow");
      }

      function registermessage(callback) {
        $('.alert').css('color', '#21721c');
        $('.alert').css('background-color', '#d8f8d7');
        $('.alert').css('border-color', '#c6f5c6');
        $('.alert').html("Registrierung erfolgreich!");
        $('.alert').slideDown("slow").delay(500, function() {
          return callback();
        });
      }

      function createAuctionMessage(message, success) {
        var errorDiv = $('.create_auction_button_error > div');
        if(success) $(errorDiv).css('color', '#1d6e15');
        else $(errorDiv).css('color', '#6c1313');
        $(errorDiv).text(message);
        $(errorDiv).slideDown('slow', function() {
          setTimeout(function() {
            $(errorDiv).slideUp('slow');
          }, 2000);
        });
      }

      function switchRegister() {
        if($('.register_div #register').css('display') != 'none') {
          $('.register_div #register').slideUp("slow", function() {
            $('.register_div #login').slideDown("slow");
          });
        } else {
          $('.register_div #login').slideUp("slow", function() {
            $('.register_div #register').slideDown("slow");
          });
        }
      }

      function toggleDatabaseButton() {
        if($('.simulate_button_gradient').css('display') == 'none') $('.simulate_button_gradient').fadeIn("slow");
        else $('.simulate_button_gradient').fadeOut("slow");
      }

      function toggleDatabaseOptions() {
        if(!($('.profile_option_div').css('display') == 'none')) toggleProfileOptions();
        if($('.database_option_div').css('display') == 'none') $('.database_option_div').slideDown("slow");
        else $('.database_option_div').slideUp("slow");
      }

      function toggleProfileOptions() {
        if(!($('.database_option_div').css('display') == 'none')) toggleDatabaseOptions();
        if($('.profile_option_div').css('display') == 'none') $('.profile_option_div').slideDown("slow");
        else $('.profile_option_div').slideUp("slow");
      }

      function checkRealtime() {
        var realtime = $('input[type=checkbox]#check_realtime').prop('checked');
        if(realtime) {
          return true;
        } else {
          return false;
        }
      }

      function allowDrop(e) {
        e.preventDefault();
      }

      function drag(e) {
        e.dataTransfer.setData("text", getClassName(e.target.className, 1));
      }

      function drop(e) {
          e.preventDefault();
          var classNameToInsert = e.dataTransfer.getData("text");
          // $('.auction_item .background_overflow_div').attr('class', 'background_overflow_div');
          $('.auction_item .background_overflow_div').addClass(classNameToInsert);
          droppedItem = classNameToInsert;
      }

      function resetDrop() {
        droppedItem = null;
        var getClass = getClassName($('.auction_item .background_overflow_div').attr('class'), 1);
        $('.auction_item .background_overflow_div').removeClass(getClass);
      }

      function getClassName(className, index) {
        return className.split(" ")[index];
      }

      function clickAuctionButton() {
        var startingPrice = $('#startingPrice').val();
        var buyoutPrice = $('#buyOut').val();
        var auctionTime = $('#auctionDuration').val();

        createAuction(startingPrice, buyoutPrice, auctionTime);
      }

      $(window).resize(function() {
        resize();
      });

      function resize(obj) {
        if(obj != null) {
          var target = $(obj).attr("href");
          var oldHeight = $('.tab-pane.active').height();
          $(target).height(oldHeight);
          setTimeout(function() {
            var newHeight = $(target).children('.overflow_div').outerHeight();
            $(".tab-pane.active").height(newHeight);
          }, 300);
        } else {
          if($('#tab3.tab-pane.active').length !== 0) {
            var overflowHeight = $('.tab-pane.active .overflow_div').outerHeight();
            var tabHeight = $('.tab-pane.active').height();
            if(overflowHeight > tabHeight) {
              $(".tab-pane.active").height($('.tab-pane.active .overflow_div').outerHeight());
            } else if(overflowHeight < tabHeight) {
              $(".tab-pane.active").height($('.tab-pane.active .overflow_div').outerHeight());
            }
          }
        }
      }

      window.onclick = function(e) {
        if($('.database_option_div').css('display') == 'block') {
          var target = $(e.target).closest($('.database_option_div')).length;
          if(!target) {
            toggleDatabaseOptions();
          }
        }
      }
    </script>

    <!-- LOADING GAME -->
    <script type="text/javascript" src="js/states/Boot.js"></script>
    <script type="text/javascript" src="js/states/Preload.js"></script>
    <script type="text/javascript" src="js/states/Menu.js"></script>
    <script type="text/javascript" src="js/states/game/Game.js"></script>
    <script type="text/javascript" src="js/states/game/Movement.js"></script>
    <script type="text/javascript" src="js/states/game/Ui.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
  </body>
</html>
