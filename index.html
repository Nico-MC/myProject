<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>    <title>myproject</title>
    <!-- CSS -->
    <!-- <link href="https://fonts.googleapis.com/css?family=Skranji:700" rel="stylesheet"-->
    <link rel="stylesheet" type="text/css" href="assets/css/page.css">
    <link rel="stylesheet" type="text/css" href="assets/css/game.css">
    <link rel="stylesheet" type="text/css" href="assets/css/auctionhouse.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- DATABASE -->
    <!-- <script src="https://www.baqend.com/js-sdk/latest/baqend.min.js"></script> -->
    <script type="text/javascript" src="//unpkg.com/@reactivex/rxjs@5.2.0/dist/global/Rx.js"></script>
    <!-- include the SDK after rxjs -->
    <script type="text/javascript" src="//www.baqend.com/js-sdk/latest/baqend-realtime.js"></script>
    <!-- MODULES -->
    <script type="text/javascript" src="modules/phaser.min.js"></script>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
  </head>
  <body>
    <section></section>

    <script type="text/javascript" src="js/db_baqend.js"></script>
    <script type="text/javascript">

      // Load mit Vorsicht genießen, da asynchron.
      // Für synchones Laden Ajax
      function transferToLogin(sk) {
        if(DB.User.me.securitykey == sk) {
          $.ajax({
            url: "assets/content/content.html",
            success: function(data) {
              var data = $(data).filter('.login_content');
              $('section').html(data);
              loadLogin(); //race conditions? https://stackoverflow.com/questions/8611145/race-conditions-with-javascript-event-handling
            }
          });
          function loadLogin() {
            DB.Items.find()
                    .equal('user', DB.User.me)
                    .singleResult(function(items) {
                      initItems(items.itemlist);
                      $('.profile_option_div .username').text("Benutzername: " + DB.User.me.username);
                    });

            $('.inventar_item').click(function(e) {
              var target = e.target;
              console.log(target);
            });

            $('#search').submit(function(e) {
              e.preventDefault();
              search_result = $('#search_field').val();
              search(search_result);
            });
            // Clear text search_field
            $("#search_field").val("");

            var streamlist;
            $('#check_realtime').change(function() {
              if(checkRealtime() && (streamlist == null)) {
                subscribeRealtime(sk, function(streams) {
                  streamlist = streams;
                  console.log("Realtime is on.");
                });
              } else {
                streamlist.forEach(function(stream) {
                  stream.unsubscribe();
                });
                streamlist = null;
                console.log("All streams unsubscribed.");
                console.log("Realtime is off.");
              }
            });

            startGame();
          }
        }
      }

      function initItems(itemlist) {
        if(itemlist.length == 0) {
          $('.inventar_div').html('<span class="no_items">Keine Items vorhanden.</span>');
        } else {
          itemlist.forEach(function(item) {
            if(item.name == "gold") {
              $('.inventar_div').append('<div class="inventar_item gold"></div>');
            } else if(item.name == "iron") {
              $('.inventar_div').append('<div class="inventar_item iron"></div>');
            }
          });
        }
        resize();
      }

      function updateItems(event) {
        
        console.log(event);
      }

      function transferToRegister() {
        $.ajax({
          url: "assets/content/content.html",
          success: function(data) {
            var data = $(data).filter('.register_container');
            $('section').html(data);
            loadRegister();
          }
        });
        function loadRegister() {
          $('.register_div').fadeIn(2000);
          // Click on register-button
          $("#register").submit(function(event) {
            event.preventDefault();
            register($(this).serializeArray(), function(sk) {
              transferToLogin(sk);
            });
          });
          // Click on login-button
          $("#login").submit(function(event) {
            event.preventDefault();
            login($(this).serializeArray(), function(sk) {
              $.when( $('section .register_container').fadeOut("slow") ).done(function() {
                 transferToLogin(sk);
              });
            });
          });
        }
      }

      function errormessage(message) {
        $('.alert').css('color', '#721c24');
        $('.alert').css('background-color', '#f8d7da');
        $('.alert').css('border-color', '#f5c6cb');
        $('.alert').html(message);
        $('.alert').toggle("slow").delay(2000).toggle("slow");
      }

      function registermessage(callback) {
        $('.alert').css('color', '#21721c');
        $('.alert').css('background-color', '#d8f8d7');
        $('.alert').css('border-color', '#c6f5c6');
        $('.alert').html("Registrierung erfolgreich!");
        $('.alert').slideDown("slow").delay(500, function() {
          return callback();
        });
      }

      function switchRegister() {
        if($('.register_div #register').css('display') != 'none') {
          $('.register_div #register').slideUp("slow", function() {
            $('.register_div #login').slideDown("slow");
          });
        } else {
          $('.register_div #login').slideUp("slow", function() {
            $('.register_div #register').slideDown("slow");
          });
        }
      }

      function toggleDatabaseButton() {
        if($('.simulate_button_gradient').css('display') == 'none') $('.simulate_button_gradient').fadeIn("slow");
        else $('.simulate_button_gradient').fadeOut("slow");
      }

      function toggleDatabaseOptions() {
        if(!($('.profile_option_div').css('display') == 'none')) toggleProfileOptions();
        if($('.database_option_div').css('display') == 'none') $('.database_option_div').slideDown("slow");
        else $('.database_option_div').slideUp("slow");
      }

      function toggleProfileOptions() {
        if(!($('.database_option_div').css('display') == 'none')) toggleDatabaseOptions();
        if($('.profile_option_div').css('display') == 'none') $('.profile_option_div').slideDown("slow");
        else $('.profile_option_div').slideUp("slow");
      }

      function checkRealtime() {
        var realtime = $('input[type=checkbox]#check_realtime').prop('checked');
        if(realtime) {
          return true;
        } else {
          return false;
        }
      }

      $(window).resize(function() {
        resize();
      });

      function resize(obj) {
        if(obj != null) {
          var target = $(obj).attr("href");
          var oldHeight = $('.tab-pane.active').height();
          $(target).height(oldHeight);
          setTimeout(function() {
            var newHeight = $(target).children('.overflow_div').outerHeight();
            $(".tab-pane.active").height(newHeight);
          }, 300);
        } else {
          if($('#tab3.tab-pane.active').length !== 0) {
            var overflowHeight = $('.tab-pane.active .overflow_div').outerHeight();
            var tabHeight = $('.tab-pane.active').height();
            if(overflowHeight > tabHeight) {
              $(".tab-pane.active").height($('.tab-pane.active .overflow_div').outerHeight());
            } else if(overflowHeight < tabHeight) {
              $(".tab-pane.active").height($('.tab-pane.active .overflow_div').outerHeight());
            }
          }
        }
      }

      window.onclick = function(e) {
        if($('.database_option_div').css('display') == 'block') {
          var target = $(e.target).closest($('.database_option_div')).length;
          if(!target) {
            toggleDatabaseOptions();
          }
        }
      }
    </script>

    <!-- LOADING GAME -->
    <script type="text/javascript" src="js/states/Boot.js"></script>
    <script type="text/javascript" src="js/states/Preload.js"></script>
    <script type="text/javascript" src="js/states/Menu.js"></script>
    <script type="text/javascript" src="js/states/game/Game.js"></script>
    <script type="text/javascript" src="js/states/game/Movement.js"></script>
    <script type="text/javascript" src="js/states/game/Ui.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
  </body>
</html>
